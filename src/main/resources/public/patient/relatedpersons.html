<!--
  ~ Copyright (c) Stichting Koppeltaal 2021.
  ~
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
  -->

<html lang="en">
<head>
    <title>Het Portaal - groups</title>
    <link rel="icon" type="image/svg+xml" href="../icons/public-24px.svg">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"
          media="screen,projection"/>

</head>
<body>

<nav class="nav-extended teal darken-1">
    <div class="nav-wrapper ">
        &nbsp; <a href="#" class="brand-logo">Het Portaal <i class="large material-icons">public</i></a>
        <ul id="nav-mobile" class="right">
            <li><a href="/logout">Logout</a></li>
        </ul>
    </div>
    <div class="nav-content loggedin teal lighten-3">
        <ul class="tabs tabs-transparent">
            <li class="tab"><a href="index.html">Main</a></li>
            <li class="tab"><a href="tasks.html">Tasks</a></li>
            <li class="tab"><a href="relatedpersons.html" class="active">Friends & Family</a></li>
            <li class="tab"><a href="careteams.html">Groups</a></li>
            <li class="tab right"><a href="/logout" class="user"></a></li>
        </ul>
    </div>
</nav>
<div class="container content-tab relatedpersons">
    <div class="row">
        <div class="col s12">
            <h2>Friends & Family</h2>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <table class="data">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Relation</th>
                    <th>E-mail</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <form action="/api/RelatedPerson" data-tab="relatedPersons" class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Invite a related person</span>

                    <input name="reference" id="reference" type="hidden"/>
                    <input name="active" id="active" type="hidden" value="true"/>
                    <input name="identifierSystem" id="identifierSystem" type="hidden" value="https://irma.app/email"/>
                    <input name="patient" id="patient" type="hidden" value=""/>
                    <input name="organization" id="organization" type="hidden" value=""/>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">portrait</i>
                            <input placeholder="joe@example.com" name="identifierValue" id="identifierValue"
                                   type="text" class="validate">
                            <label for="identifierValue">Email</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">person</i>
                            <input type="hidden" id="relationship_shadow" value=""/>
                            <select id="relationship" name="relationship">
                                <option value="">[NONE]</option>
                            </select>
                            <label for="relationship">Relationship</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <i class="material-icons prefix">account_circle</i>
                            <input placeholder="Voornaam(en)" name="nameGiven" id="nameGiven" type="text"
                                   class="validate">
                            <label for="nameGiven">First Name</label>
                        </div>
                        <div class="input-field col s6">
                            <i class="material-icons prefix">account_circle</i>
                            <input placeholder="Achternaam" name="nameFamily" id="nameFamily" type="text"
                                   class="validate">
                            <label for="nameFamily">Last Name</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <i class="material-icons prefix">contact_mail</i>
                            <input placeholder="work@example.com" name="email" id="email" type="text"
                                   class="validate">
                            <label for="email">E-mail</label>
                        </div>
                        <div class="input-field col s6">
                            <i class="material-icons prefix">contact_phone</i>
                            <input placeholder="06-432311322" name="phone" id="phone" type="text"
                                   class="validate">
                            <label for="phone">Phone</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">local_post_office</i>
                            <textarea placeholder="Heilgeweg 26-28" name="addressLines" id="addressLines"
                                      class="materialize-textarea"></textarea>
                            <label for="addressLines">Address Lines</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s4">
                            <i class="material-icons prefix">location_city</i>
                            <input placeholder="Amsterdam" name="addressCity" id="addressCity" type="text"
                                   class="validate">
                            <label for="addressCity">City</label>
                        </div>
                        <div class="input-field col s4">
                            <i class="material-icons prefix">code</i>
                            <input placeholder="1012 XR" name="addressPostalCode" id="addressPostalCode" type="text"
                                   class="validate">
                            <label for="addressPostalCode">ZIP code</label>
                        </div>
                        <div class="input-field col s4">
                            <i class="material-icons prefix">flag</i>
                            <input placeholder="NL" name="addressCountry" id="addressCountry" type="text"
                                   class="validate">
                            <label for="addressCountry">Country</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <i class="material-icons prefix">perm_identity</i>
                            <select id="gender" name="gender">
                                <option value="unknown">Unknown</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                                <option value="other">Other</option>
                            </select>
                            <label for="gender">Gender</label>
                        </div>
                        <div class="input-field col s6">
                            <i class="material-icons prefix">date_range</i>
                            <input class="datepicker validate" name="birthDate" id="birthDate" type="text">
                            <label for="birthDate">Birthdate (dd-mm-yyyy)</label>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn waves-effect waves-light" type="reset" name="action">Reset
                        <i class="material-icons left">clear</i>
                    </button>
                    <button class="btn waves-effect waves-light" type="submit" name="action">Submit
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </div>
        </form>
    </div>

</div>

<!--JavaScript at end of body for optimized loading-->
<script type="text/javascript" src="../js/materialize.min.js"></script>
<script type="text/javascript" src="../js/utils.js"></script>
<script>
  var currentUser;
  const render = () => {

    fetch('/api/RelatedPerson?t_=' + new Date().getTime())
      .then(jsonResponseHandler)
      .then((data) => {
        const tdata = document.querySelector('div.relatedpersons table.data tbody');
        tdata.innerHTML = '';
        for (let relatedPerson of Object.values(data)) {
          const tr = document.createElement('tr');

          tr.append(createTd(relatedPerson.nameGiven, relatedPerson.nameFamily));
          tr.append(createTd(codeSystemDisplayNames[relatedPerson.relationship]));
          tr.append(createTd(relatedPerson.identifierValue, relatedPerson.homeEmail, relatedPerson.workEmail));
          let td = document.createElement('td');
          let deleteAction = parseHtml('<a href="#" class="waves-effect waves-light btn-small"><i class="small material-icons left">delete_forever</i>delete</a>')
          deleteAction.setAttribute("data-reference", relatedPerson.reference)
          deleteAction.onclick = (e) => {
            const reference = e.target.getAttribute("data-reference");
            fetch('/api/' + reference, {method: 'DELETE'}).then(() => {
              render();
            });
            return false;
          }
          td.append(deleteAction);
          td.append(' ');
          let editAction = parseHtml('<a href="#" class="waves-effect waves-light btn-small"><i class="small material-icons left">edit</i>edit</a>')
          editAction.setAttribute("data-reference", relatedPerson.reference)
          editAction.onclick = (e) => {
            document.getElementById('reference').value = e.target.getAttribute("data-reference");
            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("change", false, true);
            document.getElementById('reference').dispatchEvent(evt);
            return false;
          }
          td.append(editAction);
          tr.append(td);
          tdata.append(tr);
        }
      });
  }

  const registerFormInputListeners = () => {
    document.getElementById('reference').onchange = (e) => {
      let input = e.target;
      let value = input.value
      if (value) {
        fetch('/api/' + value)
          .then(jsonResponseHandler)
          .then((data) => {
            for (let [key, value] of Object.entries(data)) {
              let element = document.getElementById(key);
              if (element) {
                if (element.nodeName === 'TEXTAREA') {
                  element.textContent = readValue(value, key);
                } else {
                  element.value = readValue(value, key);
                }
                if (element !== input) {
                  var event = new Event('change');
                  element.dispatchEvent(event)
                }
              }
            }
          })
          .then(updateForm)
          .catch(reason => {
            // ignore
            console.log(reason)
          })
      }
    }
  }

  let codeSystemDisplayNames = {}


  const loadCodeSystems = () => {
    codeSystemDisplayNames = {}
    const CODE_SYSTEMS = ['http://terminology.hl7.org/CodeSystem/v2-0131', 'http://terminology.hl7.org/CodeSystem/v3-RoleCode'];
    const relationshipEl = document.getElementById('relationship');
    relationshipEl.innerHTML = '';
    for (const codeSystem of CODE_SYSTEMS) {
      fetch('/api/codesystem?codeSystem=' + encodeURIComponent(codeSystem), {cache: "force-cache"})
        .then(jsonResponseHandler)
        .then((data) => {
          const codeSystemUri = data['uri'];
          relationshipEl.append(parseHtml('<option value="">[NONE]</option>'));
          let concepts = data['concept'];
          concepts.forEach((concept) => {
            const key = codeSystemUri + '|' + concept.code;
            codeSystemDisplayNames[key] = concept.display
            relationshipEl.append(parseHtml('<option value="' + key + '">' + concept.display + '</option>'));
          });
        }).then(updateForm);
    }
  }
  document.addEventListener('DOMContentLoaded', function () {
    fetch('/api/user/current')
      .then(jsonResponseHandler)
      .then((user) => {
        if (user.loggedIn) {
          currentUser = user;
          document.getElementById('patient').value = currentUser.patient.reference || '';
          document.getElementById('organization').value = currentUser.patient.organization || '';
          render()
          registerFormInputListeners();
          loadCodeSystems();
          registerFormSubmitListeners(render);
          enableMaterializeElements();
          insertCurrentUser(currentUser);
        } else {
          let res = window.confirm("It seems you are logged out, go to the login page?")
          if (res) {
            window.location = '/login';
          }
        }
      });
  }, false);
</script>
</body>
</html>
